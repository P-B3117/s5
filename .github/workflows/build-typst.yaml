name: Build Typst Documents

on:
    push:
        branches:
            - main
    pull_request:
    workflow_dispatch:

jobs:
    discover:
        runs-on: ubuntu-latest
        outputs:
            matrix: ${{ steps.set-matrix.outputs.matrix }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Find Typst files
              id: set-matrix
              run: |
                  files=$(find . -name "main.typ" -type f | jq -R -s -c 'split("\n")[:-1]')
                  echo "matrix=$files" >> "$GITHUB_OUTPUT"

    build:
        needs: discover
        runs-on: ubuntu-latest
        strategy:
            matrix:
                file: ${{ fromJson(needs.discover.outputs.matrix) }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Typst
              uses: typst-community/setup-typst@v3
              with:
                  typst-version: "latest"

            - name: Build Typst document
              run: |
                  file="${{ matrix.file }}"
                  dir=$(dirname "$file")
                  parent_dir=$(basename "$(dirname "$dir")")
                  current_dir=$(basename "$dir")
                  output_name="${parent_dir}-${current_dir}.pdf"

                  echo "Building: $file -> $dir/$output_name"
                  cd "$dir"
                  typst compile main.typ "$output_name"

                  echo "pdf_path=$dir/$output_name" >> "$GITHUB_ENV"
                  echo "artifact_name=${parent_dir}-${current_dir}" >> "$GITHUB_ENV"

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ env.artifact_name }}
                  path: ${{ env.pdf_path }}
